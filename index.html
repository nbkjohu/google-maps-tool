<script>
let currentLocation = null;
let retryCount = 0;
const maxRetries = 3;

function getCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        console.log("Live Location Data:", position.coords);
        if (position.coords.accuracy > 100) {
          alert("Low accuracy. Retrying...");
          retryLocation();
          return;
        }
        retryCount = 0;
        currentLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        };
        document.getElementById("your-location").value = `${currentLocation.lat}, ${currentLocation.lng}`;
        updateMap(currentLocation);
      },
      (error) => {
        console.error("Geolocation Error:", error);
        if (error.code === error.TIMEOUT || error.code === error.POSITION_UNAVAILABLE) {
          retryLocation();
        } else {
          alert("Failed to fetch location. Falling back to IP-based location.");
          getIPLocation();
        }
      },
      { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
    );
  } else {
    alert("Geolocation is not supported by your browser.");
    getIPLocation();
  }
}

function retryLocation() {
  if (retryCount >= maxRetries) {
    alert("Failed to get high-accuracy location after retries.");
    getIPLocation();
    return;
  }
  retryCount++;
  console.warn(`Retrying (${retryCount}/${maxRetries})...`);
  setTimeout(() => getCurrentLocation(), 2000);
}

async function getIPLocation() {
  try {
    const response = await fetch("https://ipinfo.io/json?token=YOUR_TOKEN");
    const data = await response.json();
    const [lat, lng] = data.loc.split(",");
    console.log("IP-Based Location:", { lat, lng });
    currentLocation = { lat: parseFloat(lat), lng: parseFloat(lng) };
    document.getElementById("your-location").value = `${currentLocation.lat}, ${currentLocation.lng}`;
    updateMap(currentLocation);
  } catch (error) {
    console.error("IP Location Fetch Error:", error);
    alert("Failed to fetch location.");
  }
}

function updateMap(location) {
  map.setCenter(location);
  new google.maps.marker.AdvancedMarkerElement({
    position: location,
    map: map,
    title: "Your Live Location",
  });
}
</script>
