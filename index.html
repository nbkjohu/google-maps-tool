<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Google Maps with IP Geolocation</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    #map {
      height: 400px;
      width: 100%;
      margin-bottom: 15px;
    }
    #info {
      font-size: 16px;
      margin-top: 10px;
    }
    #recent-searches ul {
      list-style: none;
      padding: 0;
    }
    #recent-searches ul li {
      cursor: pointer;
      text-decoration: underline;
      color: blue;
    }
    #recent-searches ul li:hover {
      color: darkblue;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCp2c5_T9vlA4a0bc1ANq-0sA13t86T024&libraries=places"></script>
</head>
<body>
  <div class="container">
    <h1 class="text-center my-4">Enhanced Google Maps with IP Geolocation</h1>
    <div class="row mb-3">
      <div class="col-md-4">
        <input type="text" id="current-location" class="form-control" placeholder="Your location">
        <button id="get-location" class="btn btn-primary mt-2">Get Location via IP</button>
      </div>
      <div class="col-md-4">
        <input type="text" id="destination" class="form-control" placeholder="Destination">
      </div>
      <div class="col-md-4">
        <select id="mode" class="form-select">
          <option value="DRIVING">Driving</option>
          <option value="WALKING">Walking</option>
          <option value="BICYCLING">Bicycling</option>
          <option value="TRANSIT">Transit</option>
        </select>
        <button id="get-directions" class="btn btn-success mt-2">Search</button>
        <button id="clear-directions" class="btn btn-danger mt-2">Clear</button>
      </div>
    </div>
    <div id="map"></div>
    <div id="info" class="text-success"></div>
    <div id="weather" class="text-info"></div>
    <div id="recent-searches">
      <h3>Recent Searches</h3>
      <ul id="search-list"></ul>
    </div>
  </div>
  <script>
    let map, directionsService, directionsRenderer, currentLocation, trafficLayer, autocomplete;
    const apiKey = "AIzaSyCp2c5_T9vlA4a0bc1ANq-0sA13t86T024"; // Replace with your API Key

    // Initialize the map
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 28.6139, lng: 77.209 },
        zoom: 12,
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer();
      directionsRenderer.setMap(map);

      trafficLayer = new google.maps.TrafficLayer();

      // Add Autocomplete to the Destination Field
      const destinationInput = document.getElementById("destination");
      autocomplete = new google.maps.places.Autocomplete(destinationInput);
    }

    // Get location via IP
    async function getLocation() {
      try {
        const response = await fetch("https://ipapi.co/json/");
        const data = await response.json();
        currentLocation = { lat: data.latitude, lng: data.longitude };
        document.getElementById("current-location").value = `${data.latitude}, ${data.longitude}`;
        map.setCenter(currentLocation);
        new google.maps.Marker({ position: currentLocation, map: map });
        getWeather(data.latitude, data.longitude);
      } catch (error) {
        alert("Failed to fetch your location");
      }
    }

    // Fetch Weather Information
    async function getWeather(lat, lng) {
      const weatherAPI = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=YOUR_OPENWEATHER_API_KEY&units=metric`;
      try {
        const response = await fetch(weatherAPI);
        const weatherData = await response.json();
        document.getElementById("weather").innerHTML = `
          <strong>Weather:</strong> ${weatherData.weather[0].description}, 
          <strong>Temp:</strong> ${weatherData.main.temp}Â°C
        `;
      } catch (error) {
        console.error("Error fetching weather data:", error);
      }
    }

    // Get directions
    function getDirections() {
      const destination = document.getElementById("destination").value;
      const mode = document.getElementById("mode").value;

      directionsService.route(
        {
          origin: currentLocation,
          destination: destination,
          travelMode: google.maps.TravelMode[mode],
        },
        (response, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(response);
            const route = response.routes[0].legs[0];
            document.getElementById("info").innerHTML = `
              <strong>Distance:</strong> ${route.distance.text} <br>
              <strong>Duration:</strong> ${route.duration.text}
            `;
            saveSearch(destination);
          } else {
            alert("Directions request failed due to " + status);
          }
        }
      );
    }

    // Save recent searches
    function saveSearch(destination) {
      const list = document.getElementById("search-list");
      const li = document.createElement("li");
      li.textContent = destination;
      li.onclick = () => {
        document.getElementById("destination").value = destination;
        getDirections();
      };
      list.appendChild(li);
    }

    // Toggle traffic
    function toggleTraffic() {
      trafficLayer.setMap(trafficLayer.getMap() ? null : map);
    }

    // Clear map
    function clearDirections() {
      directionsRenderer.set("directions", null);
      document.getElementById("info").innerHTML = "";
    }

    document.getElementById("get-location").addEventListener("click", getLocation);
    document.getElementById("get-directions").addEventListener("click", getDirections);
    document.getElementById("clear-directions").addEventListener("click", clearDirections);

    window.onload = initMap;
  </script>
</body>
</html>
